# Phase E–F: Opportunities and Solutions / Migration Planning

**Проект:** Meetup Reservation (монорепозиторий)  
**Методология:** TOGAF ADM  
**Версия:** 1.0  
**Зависимости:** [Phase A: Architecture Vision](./phase-a-architecture-vision.md), [Phase B: Business Architecture](./phase-b-business-architecture.md), [Phase C: Information Systems Architectures](./phase-c-information-systems-architecture.md), [Phase D: Technology Architecture](./phase-d-technology-architecture.md)

---

## 1. Цели Phase E и Phase F

### 1.1 Phase E: Opportunities and Solutions

- Определить **варианты решений** для закрытия разрывов между Baseline и Target Architecture.
- Сформировать **Architecture Roadmap** — консолидированный план перехода.
- Согласовать подход к реализации.

### 1.2 Phase F: Migration Planning

- Детализировать **Implementation and Migration Plan** — рабочие пакеты, последовательность, итерации.
- Определить **Transition Architectures** — промежуточные состояния с непрерывной ценностью.
- Согласовать план с заинтересованными сторонами.

### 1.3 Контекст проекта

Проект **greenfield**: Baseline — отсутствие специализированной платформы. Миграция данных не требуется. Все компоненты создаются с нуля.

---

## 2. Consolidated Gaps, Solutions & Dependencies Matrix

Сводная матрица разрывов из Phase B, C, D и вариантов решений:

| # | Gap (Baseline → Target) | Источник | Решение | Зависимости |
|---|--------------------------|----------|---------|-------------|
| G1 | Ручное создание событий → Платформа с формами, типами билетов | Phase B | RC-4, ABB-04 | RC-1, RC-3 |
| G2 | Разрозненные регистрации → Единая регистрация с проверкой дублей | Phase B | RC-5, ABB-05 | RC-1, RC-4 |
| G3 | Ручные уведомления → Автоматические email-уведомления | Phase B | RC-6, ABB-06, ABB-11 | RC-1, TRC-5 |
| G4 | Бумажные списки → Цифровой чек-ин, экспорт Excel/PDF | Phase B | RC-8, ABB-08 | RC-1, RC-5 |
| G5 | Нет каталога → Единый каталог с фильтрацией и сортировкой | Phase B | RC-4, ABB-04 | RC-1, RC-3 |
| G6 | Нет мультитенантности → Изоляция по организаторам | Phase B | RC-3, RC-4, ABB-03, ABB-04 | RC-1 |
| G7 | Нет модерации → Постмодерация, блокировка | Phase B | RC-7, ABB-07 | RC-1, RC-3 |
| G8 | Нет личного кабинета участника → «Мои регистрации» | Phase B | RC-5, ABB-05 | RC-1, RC-3 |
| D1 | Нет БД → PostgreSQL с полной схемой | Phase C | TRC-2, ABB-10 | TRC-1 |
| D2 | Нет модели → 11 сущностей, связи, индексы | Phase C | TRC-2 (SQL-скрипты) | TRC-1 |
| D3 | Нет миграций → Ручные SQL-скрипты в `src/backend/db/` | Phase C | TRC-2 | TRC-1 |
| A1 | Нет backend → ASP.NET Core API | Phase C | TRC-3, RC-1, ABB-02 | TRC-1 |
| A2 | Нет frontend → React SPA | Phase C | TRC-4, RC-2, ABB-01 | TRC-1 |
| A3 | Нет auth → JWT, роли | Phase C | RC-3, ABB-03 | RC-1 |
| A4 | Нет email → MailKit + локальный SMTP | Phase C | RC-6, TRC-5, ABB-11 | TRC-1 |
| A5 | Нет экспорта → ClosedXML, PdfSharp | Phase C | RC-8, ABB-08 | RC-1 |
| T1–T7 | Нет инфраструктуры → Полный технологический стек | Phase D | TRC-1–TRC-7 | — |

---

## 3. Варианты решений (Solution Options)

### 3.1 Подход к реализации

| Вариант | Описание | Рекомендация |
|---------|----------|--------------|
| **A: Полная разработка с нуля** | Последовательная реализация всех компонентов по Architecture Roadmap | **Рекомендуется** — greenfield, нет legacy |
| B: MVP с последующим расширением | Минимальный MVP (каталог + регистрация), затем остальное | Альтернатива при ограниченных ресурсах |
| C: Аутсорсинг / подряд | Передача разработки внешней команде | Возможно при наличии бюджета и чёткой спецификации |

**Выбранный вариант:** A — полная разработка с нуля, итеративная поставка по фазам (см. раздел 6).

### 3.2 Варианты развёртывания (решение в Phase G/H)

Согласно Phase A и D, хостинг не определён. Варианты для последующего выбора:

| Вариант | Описание | Когда рассматривать |
|---------|----------|---------------------|
| Self-hosted (VM) | Linux/Windows VM, Nginx/Caddy, .NET, PostgreSQL, локальный SMTP | При наличии собственной инфраструктуры |
| Cloud (IaaS/PaaS) | Azure, AWS, GCP, Yandex Cloud | При предпочтении managed-сервисов |
| SaaS (Heroku, Railway, Render) | Managed runtime, managed DB, add-on SMTP | При быстром старте и ограниченном DevOps |

### 3.3 Риски и допущения

| ID | Риск / допущение | Митигация |
|----|------------------|-----------|
| R1 | .NET 10 в preview — возможны изменения API | Следить за релизами; при необходимости — откат на .NET 8/9 |
| R2 | Локальный SMTP в production — доставка писем | Настроить мониторинг очереди; в следующих фазах — внешний SMTP |
| A1 | Команда владеет ASP.NET Core, React, PostgreSQL | Обучение при необходимости |
| A2 | Развёртывание будет определено до production | Решение в Phase G |

---

## 4. Consolidated Architecture Roadmap

Объединённый план из Phase B (RC), Phase C (ABB), Phase D (TRC):

```
Baseline (текущее состояние)
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Итерация 0: Фундамент (TRC-1, TRC-2, TRC-3, TRC-4, TRC-5)                   │
│  - Монорепозиторий, структура src/backend/, src/frontend/, src/backend/db/  │
│  - PostgreSQL: схема, индексы, скрипт первого администратора               │
│  - Backend: каркас ASP.NET Core, Data Access (Dapper)                        │
│  - Frontend: каркас React + Vite, конфиг API                                 │
│  - Локальный SMTP (MailHog / Ethereal для dev)                               │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Итерация 1: Аутентификация и базовые сущности (RC-3, RC-4 частично)        │
│  - Auth Module: регистрация, login, JWT, Argon2id, роли                      │
│  - Events Module: CRUD событий, типы билетов, категории, изображения        │
│  - Каталог (публичный), страница организатора                                │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Итерация 2: Регистрация и уведомления (RC-5, RC-6)                          │
│  - Registrations Module: регистрация на мероприятие, проверка дублей         │
│  - Оплата-заглушка, ограничение мест                                         │
│  - Notifications Module: MailKit, подтверждение, напоминания, отмена         │
│  - Личный кабинет участника («Мои регистрации»)                              │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Итерация 3: Управление и администрирование (RC-6, RC-7, RC-8)              │
│  - Чек-ин (ручная отметка), отмена регистрации                               │
│  - Export Module: ClosedXML, PdfSharp (Excel/PDF)                           │
│  - Admin Module: модерация, блокировка, управление пользователями/категориями│
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Итерация 4: Интеграция и развёртывание (TRC-6, TRC-7)                       │
│  - Раздача статики (Kestrel или reverse proxy)                               │
│  - Выбор и настройка варианта развёртывания                                  │
│  - Ручное тестирование, исправление дефектов                                 │
└─────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
Target Architecture (первая версия)
```

---

## 5. Building Blocks — Сводная таблица

| ID | Building Block | Источник | Итерация | Описание |
|----|----------------|----------|----------|----------|
| **TRC-1** | Technology Stack Setup | Phase D | 0 | .NET 10, PostgreSQL, Node.js 22 LTS, npm, монорепозиторий |
| **TRC-2** | Database Infrastructure | Phase D | 0 | SQL-скрипты в `src/backend/db/`, схема, индексы, скрипт первого администратора |
| **TRC-3** | Backend Runtime | Phase D | 0 | ASP.NET Core, Kestrel, каркас модулей |
| **TRC-4** | Frontend Build | Phase D | 0 | React + Vite, каркас SPA, конфиг (JSON) |
| **TRC-5** | Email Infrastructure | Phase D | 0 | Локальный SMTP (MailHog/Ethereal для dev) |
| **RC-3** | Auth Module | Phase B | 1 | JWT, Argon2id, роли, регистрация, login |
| **RC-4** | Events Module | Phase B | 1 | CRUD событий, типы билетов, категории, фото, каталог |
| **RC-5** | Registrations Module | Phase B | 2 | Регистрация, проверка дублей, оплата-заглушка, ЛК участника |
| **RC-6** | Notifications Module | Phase B | 2 | MailKit, подтверждение, напоминания, отмена |
| **RC-7** | Admin Module | Phase B | 3 | Модерация, блокировка, пользователи, категории |
| **RC-8** | Export Module | Phase B | 3 | ClosedXML (Excel), PdfSharp (PDF) |
| **TRC-6** | Раздача статики / Reverse Proxy | Phase D | 4 | Kestrel UseStaticFiles или Nginx/Caddy/IIS |
| **TRC-7** | Deployment Pipeline | Phase D | 4 | CI/CD, выбор варианта развёртывания |

---

## 6. Implementation and Migration Plan — Итерации

### 6.1 Обзор итераций

| Итерация | Название | Цель | Длительность (оценка) | Критерии готовности |
|----------|----------|------|------------------------|---------------------|
| **0** | Фундамент | Инфраструктура, БД, каркас backend/frontend | 1–2 спринта | Backend отвечает на health-check; Frontend отображает заглушку; БД создана |
| **1** | Аутентификация и события | Регистрация, вход, создание событий, каталог | 2–3 спринта | Организатор может создать событие; посетитель видит каталог; можно зарегистрироваться на платформе |
| **2** | Регистрация и уведомления | Регистрация на мероприятия, email | 2–3 спринта | Посетитель может зарегистрироваться на мероприятие; получает email; ЛК участника работает |
| **3** | Управление и администрирование | Чек-ин, экспорт, модерация | 2 спринта | Организатор управляет участниками, экспортирует; администратор модерирует |
| **4** | Интеграция и развёртывание | Сборка, раздача статики, deployment | 1–2 спринта | Система развёрнута; ручное тестирование пройдено |

### 6.2 Последовательность изменений (детально)

#### Итерация 0: Фундамент

| # | Work Package | Действия | Результат |
|---|--------------|----------|-----------|
| WP-0.1 | Создание монорепозитория | Инициализация Git; структура `src/backend/`, `src/frontend/`, `src/backend/db/` | Репозиторий готов |
| WP-0.2 | Backend каркас | ASP.NET Core Web API, Kestrel, CORS (AllowAnyOrigin), конфигурация (appsettings, env) | Backend запускается |
| WP-0.3 | Схема БД | SQL-скрипты: users, user_roles, organizer_profiles, participant_profiles, categories, events, event_categories, ticket_types, registrations, event_images, event_attachments | Схема создана |
| WP-0.4 | Data Access | Dapper, connection string, базовые репозитории/запросы | Доступ к БД |
| WP-0.5 | Скрипт первого администратора | SQL в `src/backend/db/` для создания admin | Скрипт готов |
| WP-0.6 | Frontend каркас | React + TypeScript + Vite, npm, конфиг API (JSON в src/) | SPA собирается |
| WP-0.7 | SMTP для dev | MailHog или Ethereal, настройка в appsettings | Email в dev работает |

#### Итерация 1: Аутентификация и события

| # | Work Package | Действия | Результат |
|---|--------------|----------|-----------|
| WP-1.1 | Auth Module | Регистрация (role: organizer \| participant), login, JWT (1 ч), Argon2id, user_roles | Endpoints /auth/register, /auth/login |
| WP-1.2 | Events Module (backend) | CRUD событий, типы билетов, категории, изображения (BLOB), изоляция по organizer_id | API событий |
| WP-1.3 | Каталог (backend) | GET /events с фильтрами, сортировкой, cursor-пагинацией | API каталога |
| WP-1.4 | Frontend: Auth | Страницы регистрации, входа, хранение JWT | UI авторизации |
| WP-1.5 | Frontend: Каталог | Страница каталога, фильтры, сортировка, страница события | UI каталога |
| WP-1.6 | Frontend: Кабинет организатора | Создание события, типы билетов, загрузка фото | UI создания события |

#### Итерация 2: Регистрация и уведомления

| # | Work Package | Действия | Результат |
|---|--------------|----------|-----------|
| WP-2.1 | Registrations Module | POST /registrations, проверка UNIQUE(event_id, email), ограничение мест, оплата-заглушка | API регистрации |
| WP-2.2 | Notifications Module | MailKit, шаблоны: подтверждение, напоминания (день/час), отмена | Email отправляется |
| WP-2.3 | Фоновые задачи | Напоминания за день/час (IHostedService или аналог) | Напоминания по расписанию |
| WP-2.4 | Frontend: Регистрация на мероприятие | Форма, выбор билета, ввод данных, автозаполнение для залогиненных | UI регистрации |
| WP-2.5 | Frontend: Личный кабинет участника | «Мои регистрации», отмена своей регистрации | UI ЛК участника |

#### Итерация 3: Управление и администрирование

| # | Work Package | Действия | Результат |
|---|--------------|----------|-----------|
| WP-3.1 | Чек-ин и отмена | PATCH /registrations/{id}/check-in, DELETE /registrations/{id} | API чек-ина |
| WP-3.2 | Export Module | ClosedXML (Excel), PdfSharp (PDF), GET /export | API экспорта |
| WP-3.3 | Admin Module | Блокировка событий/организаторов/пользователей, управление категориями | API админки |
| WP-3.4 | Frontend: Управление участниками | Список участников, чек-ин, отмена, экспорт | UI организатора |
| WP-3.5 | Frontend: Админ-панель | Модерация, пользователи, категории | UI админки |

#### Итерация 4: Интеграция и развёртывание

| # | Work Package | Действия | Результат |
|---|--------------|----------|-----------|
| WP-4.1 | Раздача статики | Kestrel UseStaticFiles или настройка Nginx/Caddy | SPA отдаётся backend или proxy |
| WP-4.2 | Production конфигурация | Переменные окружения, JWT в конфиге (v1), SMTP | Конфиг для production |
| WP-4.3 | Выбор варианта развёртывания | Решение: VM / Cloud / SaaS | Вариант выбран |
| WP-4.4 | Ручное тестирование | Проверка сценариев по FR | Дефекты исправлены |
| WP-4.5 | Документация | README, инструкция по развёртыванию | Документация готова |

### 6.3 Transition Architecture States

| Состояние | После итерации | Бизнес-ценность |
|-----------|----------------|-----------------|
| **T0** | 0 | Нет (инфраструктура) |
| **T1** | 1 | Организатор может создать событие; посетитель видит каталог; регистрация на платформе |
| **T2** | 2 | Полный цикл: регистрация на мероприятие, email, ЛК участника |
| **T3** | 3 | Управление участниками, экспорт, модерация |
| **T4** | 4 | Production-ready первая версия |

---

## 7. Implementation Factor Assessment

| Фактор | Оценка | Влияние |
|--------|--------|---------|
| **Зависимости** | TRC-1 → все остальные; RC-3 → RC-4, RC-5, RC-7 | Строгая последовательность итераций 0 → 1 → 2 → 3 → 4 |
| **Риски** | .NET 10 preview; локальный SMTP в production | Мониторинг; план перехода на внешний SMTP |
| **Ресурсы** | Backend + Frontend разработка | Рекомендуется минимум 1 backend, 1 frontend (или fullstack) |
| **Допущения** | Развёртывание определится до итерации 4 | Решение в Phase G или ранее |

---

## 8. Связь с Phase A–D

| Phase | Артефакт | Использование в E–F |
|-------|----------|---------------------|
| **Phase A** | Scope, принципы, требования | Ограничение вариантов; критерии приёмки |
| **Phase B** | RC-1–RC-8, FR/NFR, Capabilities | Work packages, Building Blocks |
| **Phase C** | ABB-01–ABB-11, DR/AR/IR, API | Детализация модулей, endpoints |
| **Phase D** | TRC-1–TRC-7, TR, TS | Технологические work packages |

---

## 9. Утверждение

| Роль | Статус | Дата |
|------|--------|------|
| Владелец продукта | Ожидает | — |
| Архитектор | Ожидает | — |
| Технический лидер | Ожидает | — |

---

*Документ подготовлен в формате TOGAF Phase E (Opportunities and Solutions) и Phase F (Migration Planning) на основе [Phase A](./phase-a-architecture-vision.md), [Phase B](./phase-b-business-architecture.md), [Phase C](./phase-c-information-systems-architecture.md) и [Phase D](./phase-d-technology-architecture.md). Следующие этапы: Phase G (Implementation Governance) — контроль реализации; Phase H (Architecture Change Management) — управление изменениями.*
